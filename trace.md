# 存储结构

## 摘要

本文档描述的存储结构为概要性描述，只描述也一些可见的必要的字段。最终存储结构会较以下内容略微复杂。

最终存储过程是Collector高速写入Segments数据到存储系统中，由存储系统依据预设的汇总算法进行拓扑图汇总。前期考虑到
Collector已经具备了拓扑图汇总功能，那么拓扑图将直接由Collector生成并推送到存储系统中。

## 总体存储结构
```

        +-----------+          +----------------+
        |           |          |                |
+------->  MemTable +---------->  StorageEngine |
        |           |          |                |
        +-----------+          +----------------+
```

 1. MemTable: 数据首先缓存在一块内存中，用作数据批量汇总(如汇总1-10分钟)，然后生成待写入数据包。
 1. StorageEngine: 数据存储引擎。由于Trace数据Immutable的性质，且较关注近期产生的数据。故使用LSM结构的存储引擎较为合理。且LSM天生
的Key-Value形式非常适合分布式存储。

## 数据格式

```
+------------------+   +------------------+   +------------------+
|                  |   |                  |   |                  |
| Time Range Bulk1 |   | Time Range Bulk2 |   | Time Range Bulk1 | ...
|                  |   |                  |   |                  |
+------------------+   +------------------+   +------------------+
```

时间区间Bulk：将一定时间范围的数据的数据统一存储。便于删除与按照时间范围查找。一般时间范围定位1小时左右。

```
+---------------------------------+
|                                 |
|        Time Range Bulk          |
|                                 |
|   +-------------------------+   |
|   |                         |   |
|   |     Trace Storage       |   |
|   |                         |   |
|   +-------------------------+   |   ....
|                                 |
|                                 |
|   +-------------------------+   |
|   |                         |   |
|   |     Graph Storage       |   |
|   |                         |   |
|   +-------------------------+   |
|                                 |
|                                 |
|   +-------------------------+   |
|   |                         |   |
|   |     Timeseries Storage  |   |
|   |                         |   |
|   +-------------------------+   |
|                                 |
+---------------------------------+

```

 1. Trace Storage：包含Trace数据存储
 1. Graph Storage：包含拓扑图数据的存储

## Trace Storage

### 数据格式
```
+-----------------+-------------+
|                 |             |
|       Key       |  Value      |
|                 |             |
+----------------------+----+---+
|                 |    |    |   |
| trace_id        |seg1|seg2|...|
|                 |    |    |   |
+-----------------+----+----+---+

+---------------------+
|                     |
|      Seg            |
|                     |
+----+------+---------+
|    |      |         |
| len| Value| crc32   |
|    |      |         |
+----+------+---------+

```

每个segment的长度是不同的，所以len代表了value的长度，方便顺序查找。crc32用于校验value的有效性。

### 索引结构

由于LSM树本质是索引结构，故使用key来存储索引。索引内容包括timestamp，成功与否，持续时间和操作名称等。

## Graph Storage

```
+----------------------+---------------------+
|                      |                     |
|       Key            |   value             |
|                      |                     |
+--------------------------------------------+
|                      |                     |
|   rel_gloable_id     |    posting_list     |
|                      |                     |
+----------------------+---------------------+

+---------------------+   +---------------------+
|                     |   |                     |
|     rel_global_id   |   |    posting_list     |
|                     |   |                     |
+---------+-----------+   +---------+--------+--+
|         |           |   |         |        |  |
| is_first|pre_node_id|   | posting1|posting2|..|
|         |           |   |         |        |  |
+---------+-----------+   +---------+--------+--+

+-----------------------------+
|                             |
|    posting                  |
|                             |
+-------+------------+--------+
|       |            |        |
| rel_id|next_node_id|label   |
|       |            |        |
+-------+------------+--------+

```

pre_node_id，next_node_id分别代表前一个节点和后一个节点。label可以存储关系中的属性。
该存储描述在时间Bulk中的静态关系图。

## Timeseries Storage

```
+----------------------------+---------------------------------------+
|                            |                                       |
|       Key                  |      Value                            |
|                            |                                       |
+----------+--------------------------+----------+--------+----------+
|          |                 |        |          |        |          |
| target_id|begin_timestamp  |  offset| value_len| value  |  ....    |
|          |                 |        |          |        |          |
+----------+-----------------+--------+----------+--------+----------+
```
每条记录保存一定时间范围之内的数据，比如10分钟。
target_id如果为rel_id 可以保存调用数量信息，如果为cpu采样id可以保存cpu采样信息等。
begin_timestamp是这段时间的开始时间。
offset是相距begin_timestamp的时间偏移量。

## 元数据存储

存储一些必要的元数据信息
